<div class="search-component">
  <div class="search-container" tabindex="0" (keyup.enter)="searchService.submitSearch()">
    <div class="bar-buttons">
      <button
        pButton
        type="button"
        class="bar-button"
        icon="fa fa-refresh"
        title="{{ 'SEARCH_BAR.SEARCH' | translate }}"
        (click)="searchService.submitSearch()"
      ></button>
      <button
        *ngIf="searchService.resetBarButton"
        pButton
        type="button"
        class="bar-button"
        icon="fa fa-times"
        title="{{ 'SEARCH_BAR.RESET' | translate }}"
        (click)="searchService.resetSearch()"
      ></button>
      <button
        #expandButton
        (click)="clickExpandButton(expandOnClick)"
        pButton
        type="button"
        class="bar-button"
        icon="{{ expandButtonIcon }}"
        title="{{ 'SEARCH_BAR.EXPAND' | translate }}"
        *ngIf="showExpandButton"
      ></button>
    </div>
    <div
      class="parameters-container"
      #paramsContainer
      [ngStyle]="{ height: containerHeight }"
      (click)="searchService.openForm()"
      [ngClass]="{ 'hover-color-change': searchService.readOnlyBar }"
    >
      <i [ngClass]="{ 'bar-icon fa fa-bars': searchService.readOnlyBar }"></i>
      <!-- search parameters in bar -->
      <div class="all-selected-parameters" *ngIf="reloadBarParams">
        <div
          *ngFor="let p of searchService.displayParams; index as i"
          class="selected-parameter"
          [ngClass]="{ 'disabled-parameter': searchService.readOnlyBar }"
        >
          <!-- editable search parameters -->
          <div class="ui-inputgroup" *ngIf="p.getType() === paramType.SEARCH_PARAMETER">
            <span class="ui-inputgroup-addon">{{ p.getDisplayName() | translate }}</span>

            <ng-container *ngIf="p.getType() === paramType.SEARCH_PARAMETER">
              <ng-container *ngIf="p.getChoices().length === 0 || searchService.readOnlyBar; else hasChoices">
                <!-- no choice, can enter only one value -->
                <input
                  *ngIf="p.getTimesUsable() === 1"
                  [(ngModel)]="p.selected[0]"
                  type="text"
                  pInputText
                  size="15"
                  placeholder="{{ p.getPlaceholder() | translate }}"
                  [disabled]="searchService.readOnlyBar"
                />

                <!-- no choice, can enter multiple values -->
                <p-chips
                  *ngIf="p.getTimesUsable() > 1"
                  [(ngModel)]="p.selected"
                  [allowDuplicate]="false"
                  [addOnTab]="true"
                  placeholder="{{ p.getPlaceholder() | translate }}"
                  [max]="p.getTimesUsable()"
                  [addOnBlur]="true"
                  [disabled]="searchService.readOnlyBar"
                >
                  <ng-container *ngIf="searchService.readOnlyBar">
                    <ng-template let-choice pTemplate="item">
                      <span *ngIf="p.hasChoiceIcon(choice)" title="{{ p.getChoiceIconTooltip(choice) | translate }}"
                        ><i class="{{ p.getChoiceFaIcon(choice) }}"></i
                      ></span>
                      <span title="{{ p.getChoiceTooltip(choice) | translate }}"> {{ choice | translate }}</span>
                    </ng-template>
                  </ng-container>
                </p-chips>

                <button
                  *ngIf="!searchService.readOnlyBar && !p.isRequired()"
                  pButton
                  type="button"
                  icon="pi pi-times"
                  class="ui-button-danger"
                  (click)="searchService.removeDisplayParameter(p); checkOverflow()"
                ></button>
              </ng-container>

              <ng-template #hasChoices>
                <!-- Need to do these 2 separately, doesn't send back the correct values anymore when using ternary operators in ngIf and ngModel -->
                <p-dropdown
                  *ngIf="p.getTimesUsable() === 1"
                  [styleClass]="'search-bar single'"
                  [(ngModel)]="p.selected[0]"
                  [options]="p.multiSelectChoices"
                  [resetFilterOnHide]="true"
                  [filter]="true"
                  [autoDisplayFirst]="false"
                  appendTo="body"
                  (onChange)="onDropdownValueChange(p, $event)"
                >
                  <ng-template let-choice pTemplate="selectedItem">
                    <span *ngIf="p.hasChoiceIcon(choice)" title="{{ p.getChoiceIconTooltip(choice) | translate }}"
                      ><i class="{{ p.getChoiceFaIcon(choice) }}"></i
                    ></span>
                    <span title="{{ p.getChoiceTooltip(choice.value) | translate }}">
                      {{ choice.value | translate }}</span
                    >
                  </ng-template>
                  <ng-template let-choice pTemplate="item">
                    <span *ngIf="p.hasChoiceIcon(choice)" title="{{ p.getChoiceIconTooltip(choice) | translate }}"
                      ><i class="{{ p.getChoiceFaIcon(choice) }}"></i
                    ></span>
                    <span title="{{ p.getChoiceTooltip(choice.value) | translate }}">
                      {{ choice.value | translate }}</span
                    >
                  </ng-template>
                </p-dropdown>

                <p-multiSelect
                  *ngIf="p.getTimesUsable() > 1"
                  [styleClass]="'search-bar multiple'"
                  [(ngModel)]="p.selected"
                  [options]="p.multiSelectChoices"
                  [defaultLabel]="multiSelectDefaultLabel"
                  [resetFilterOnHide]="true"
                  [showToggleAll]="false"
                  (onChange)="onMultiSelectChange(p, $event)"
                  maxSelectedLabels="1"
                  selectedItemsLabel="{0} {{ multiSelectSelectedItemsLabel }}"
                  appendTo="body"
                >
                  <ng-template let-choices pTemplate="item">
                    <span
                      *ngIf="p.hasChoiceIcon(choices.value)"
                      title="{{ p.getChoiceIconTooltip(choices.value) | translate }}"
                      ><i class="{{ p.getChoiceFaIcon(choices.value) }}"></i
                    ></span>
                    <span title="{{ p.getChoiceTooltip(choices.value) | translate }}">
                      {{ choices.value | translate }}</span
                    >
                  </ng-template>
                </p-multiSelect>

                <button
                  *ngIf="!searchService.readOnlyBar && !p.isRequired()"
                  pButton
                  type="button"
                  icon="pi pi-times"
                  class="ui-button-danger"
                  (click)="searchService.removeDisplayParameter(p); checkOverflow()"
                ></button>
              </ng-template>
            </ng-container>
          </div>

          <div class="ui-inputgroup" *ngIf="p.getType() !== paramType.SEARCH_PARAMETER">
            <span class="ui-inputgroup-addon">{{ p.getDisplayName() | translate }}</span>

            <ng-container *ngIf="p.getType() === paramType.SEARCH_HOURS_RANGE">
              <p-spinner
                size="7"
                placeholder="hrs before"
                [(ngModel)]="p.hoursBefore"
                [min]="0"
                [disabled]="searchService.readOnlyBar"
              >
              </p-spinner>
              <p-spinner
                size="7"
                placeholder="hrs after"
                [(ngModel)]="p.hoursAfter"
                [min]="0"
                [disabled]="searchService.readOnlyBar"
              >
              </p-spinner>
            </ng-container>

            <ng-container *ngIf="p.getType() === paramType.SEARCH_DATETIME">
              <p-calendar
                appendTo="body"
                [(ngModel)]="p.datetime"
                [showTime]="p.includeTime"
                placeholder="{{ p.getPlaceholder() | translate }}"
                [defaultDate]="defaultDate"
                [locale]="calendarLocale"
                [disabled]="searchService.readOnlyBar"
                dataType="string"
                dateFormat="yy-mm-dd"
              >
              </p-calendar>
            </ng-container>

            <button
              *ngIf="!searchService.readOnlyBar && !p.isRequired()"
              pButton
              type="button"
              icon="pi pi-times"
              class="ui-button-danger"
              (click)="searchService.removeDisplayParameter(p); checkOverflow()"
            ></button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- suggestions/categories that show up-->
  <ng-container *ngIf="!searchService.readOnlyBar">
    <div class="search-parameter-suggestions" *ngFor="let suggestion of searchService.suggestedParams">
      <button
        pButton
        type="button"
        label="{{ suggestion.getDisplayName() | translate }}"
        class="suggestion-button"
        (click)="searchService.addSuggestedParameter(suggestion); checkOverflow(); expandParamsContainer()"
      ></button>
    </div>
  </ng-container>
</div>

<!-- Popup Search Form -->
<p-dialog
  header="{{ 'SEARCH_BAR.SEARCH' | translate }}"
  [(visible)]="searchService.displayForm"
  [modal]="true"
  styleClass="search-form"
  [blockScroll]="true"
  [focusOnShow]="false"
>
  <!-- <p-accordion>
    <p-accordionTab header="Shortcuts" [selected]="true">
      <div class="shortcut-tab">
        <div *ngFor = "let s of searchService.shortcutButtons" class="shortcut-button">
          <button pButton type="button" label="{{s.label}}" (click)="s.command()"></button>
        </div>
      </div>
    </p-accordionTab>

    <p-accordionTab header="Basic Search"> -->
  <div
    *ngFor="let p of searchService.availableParams; index as i"
    class="selected-parameter"
    tabindex="0"
    (keyup.enter)="searchService.submitSearchForm()"
  >
    <ng-container *ngIf="p.getType() === paramType.SEARCH_CHECKBOX">
      <!-- for checkbox, use the label property so it's displayed right next to the checkbox -->
      <div>
        <p-checkbox [(ngModel)]="p.formChecked" binary="true" label="{{ p.getDisplayName() | translate }}"></p-checkbox>
      </div>
    </ng-container>

    <ng-container *ngIf="p.getType() === paramType.SEARCH_PARAMETER">
      <div>{{ p.getDisplayName() | translate }}</div>

      <ng-container *ngIf="p.getChoices().length === 0; else hasChoices">
        <!-- no choice, one value -->
        <input
          *ngIf="p.getTimesUsable() === 1"
          [(ngModel)]="p.formSelected[0]"
          type="text"
          pInputText
          size="20"
          placeholder="{{ p.getPlaceholder() | translate }}"
        />

        <!-- no choice, multiple value -->
        <p-chips
          *ngIf="p.getTimesUsable() > 1"
          [(ngModel)]="p.formSelected"
          [allowDuplicate]="false"
          [max]="p.getTimesUsable()"
          [addOnTab]="true"
          [addOnBlur]="true"
          placeholder="{{ p.getPlaceholder() | translate }}"
        ></p-chips>
      </ng-container>

      <ng-template #hasChoices>
        <div class="selection-group">
          <ng-container>
            <p-dropdown
              *ngIf="p.getTimesUsable() === 1"
              [options]="p.multiSelectChoices"
              [autoDisplayFirst]="false"
              [(ngModel)]="p.formSelected[0]"
              [filter]="true"
              [resetFilterOnHide]="true"
              appendTo="body"
              (onChange)="onDropdownValueChange(p, $event)"
            >
              <ng-template let-choice pTemplate="selectedItem">
                <span *ngIf="p.hasChoiceIcon(choice)" title="{{ p.getChoiceIconTooltip(choice) | translate }}"
                  ><i class="{{ p.getChoiceFaIcon(choice) }}"></i
                ></span>
                <span title="{{ p.getChoiceTooltip(choice.value) | translate }}"> {{ choice.value | translate }}</span>
              </ng-template>
              <ng-template let-choice pTemplate="item">
                <span *ngIf="p.hasChoiceIcon(choice)" title="{{ p.getChoiceIconTooltip(choice) | translate }}"
                  ><i class="{{ p.getChoiceFaIcon(choice) }}"></i
                ></span>
                <span
                  *ngIf="!!choice.value; else emptyValue"
                  title="{{ p.getChoiceTooltip(choice.value) | translate }}"
                >
                  {{ choice.value | translate }}
                </span>
                <ng-template #emptyValue>-</ng-template>
              </ng-template>
            </p-dropdown>

            <p-multiSelect
              *ngIf="p.getTimesUsable() > 1"
              [options]="p.multiSelectChoices"
              [defaultLabel]="multiSelectDefaultLabel"
              [resetFilterOnHide]="true"
              [(ngModel)]="p.formSelected"
              (onChange)="onMultiSelectChange(p, $event)"
              maxSelectedLabels="1"
              selectedItemsLabel="{0} {{ multiSelectSelectedItemsLabel }}"
              appendTo="body"
            >
              <ng-template let-choices pTemplate="item">
                <span
                  *ngIf="p.hasChoiceIcon(choices.value)"
                  title="{{ p.getChoiceIconTooltip(choices.value) | translate }}"
                  ><i class="{{ p.getChoiceFaIcon(choices.value) }}"></i
                ></span>
                <span title="{{ p.getChoiceTooltip(choices.value) | translate }}">
                  {{ choices.value | translate }}</span
                >
              </ng-template>
            </p-multiSelect>
          </ng-container>
          <button
            pButton
            *ngIf="p.formSelected.length"
            type="button"
            (click)="p.removeAllFormValues()"
            icon="pi pi-times"
            class="clear-btn"
          ></button>
        </div>
      </ng-template>
    </ng-container>

    <ng-container *ngIf="!searchService.useDateAndHoursRange">
      <ng-container *ngTemplateOutlet="datetimeParam; context: { param: p }"> </ng-container>
      <ng-container *ngTemplateOutlet="hoursRangeParam; context: { param: p }"> </ng-container>
    </ng-container>
  </div>

  <!-- datetime and ranges -->
  <div *ngIf="searchService.useDateAndHoursRange" class="date-range-toggle">
    <div>{{ 'SEARCH_BAR.SELECT_DATE_PICKER' | translate }}</div>
    <p-selectButton
      [options]="searchService.rangeTypes"
      [(ngModel)]="searchService.selectedRangeType"
      (onChange)="onRangeTypeChange($event)"
    >
      <ng-template let-item>
        <div style="padding: 0.5em 1em;">
          <span>{{ item.label | translate }}</span>
        </div>
      </ng-template>
    </p-selectButton>

    <div
      *ngFor="let p of searchService.formRangeParams; index as i"
      class="selected-parameter"
      tabindex="0"
      (keyup.enter)="searchService.submitSearchForm()"
    >
      <ng-container *ngTemplateOutlet="datetimeParam; context: { param: p }"> </ng-container>
      <ng-container *ngTemplateOutlet="hoursRangeParam; context: { param: p }"> </ng-container>
    </div>
  </div>

  <!-- </p-accordionTab>
  </p-accordion> -->

  <p-footer>
    <button
      pButton
      type="button"
      label="{{ 'SEARCH_BAR.RESET' | translate }}"
      (click)="searchService.resetForm()"
      class="ui-button-secondary reset-button"
    ></button>
    <button
      pButton
      type="button"
      label="{{ 'SEARCH_BAR.SUBMIT' | translate }}"
      (click)="searchService.submitSearchForm()"
      class="submit-button"
    ></button>
  </p-footer>

  <ng-container *ngTemplateOutlet="toastMessages"></ng-container>
</p-dialog>

<div *ngIf="!searchService.displayForm">
  <ng-container *ngTemplateOutlet="toastMessages"></ng-container>
</div>

<ng-template #toastMessages>
  <p-toast key="search-messages" position="center">
    <ng-template let-message pTemplate="message">
      <div>
        <i class="pi pi-exclamation-triangle" style="font-size: 3em;"></i>
        <p>{{ message.summary | translate }}</p>
        <ul>
          <li *ngFor="let field of message.data">{{ field | translate }}</li>
        </ul>
      </div>
    </ng-template>
  </p-toast>
</ng-template>

<ng-template #hoursRangeParam let-p="param">
  <ng-container *ngIf="p.getType() === paramType.SEARCH_HOURS_RANGE">
    <div>
      <div>{{ 'SEARCH_BAR.HOURS_BEFORE' | translate }}</div>
      <p-spinner size="7" placeholder="hrs before" [(ngModel)]="p.formHoursBefore" [min]="0"></p-spinner>
    </div>
    <div>
      <div>{{ 'SEARCH_BAR.HOURS_AFTER' | translate }}</div>
      <p-spinner size="7" placeholder="hrs after" [(ngModel)]="p.formHoursAfter" [min]="0"></p-spinner>
    </div>
  </ng-container>
</ng-template>

<ng-template #datetimeParam let-p="param">
  <ng-container *ngIf="p.getType() === paramType.SEARCH_DATETIME">
    <div>{{ p.getDisplayName() | translate }}</div>
    <p-calendar
      [(ngModel)]="p.formDatetime"
      [showTime]="p.includeTime"
      [defaultDate]="defaultDate"
      placeholder="{{ p.getPlaceholder() | translate }}"
      appendTo="body"
      [locale]="calendarLocale"
      dataType="string"
      dateFormat="yy-mm-dd"
    >
    </p-calendar>
  </ng-container>
</ng-template>
